-- Stefano Luciano Corp
-- Sistema condiviso per tutte le creature
-- Funzioni comuni per trasformazioni e cleanup

-- Sistema di salvataggio stato originale
local originalPlayerState = {
    model = nil,
    hash = nil,
    components = {},
    props = {},
    saved = false
}

-- Stati delle creature
local creatureStates = {
    isVampire = false,
    isDemogorgon = false
}

-- ==============================
-- SALVA STATO ORIGINALE
-- ==============================
local function SaveOriginalState()
    if not originalPlayerState.saved then
        local playerPed = PlayerPedId()
        originalPlayerState.model = GetEntityModel(playerPed)
        originalPlayerState.hash = joaat('mp_m_freemode_01') -- Default fallback
        
        -- Salva tutti i componenti
        for i = 0, 11 do
            originalPlayerState.components[i] = {
                drawable = GetPedDrawableVariation(playerPed, i),
                texture = GetPedTextureVariation(playerPed, i),
                palette = GetPedPaletteVariation(playerPed, i)
            }
        end
        
        -- Salva tutti i props
        for i = 0, 7 do
            originalPlayerState.props[i] = {
                prop = GetPedPropIndex(playerPed, i),
                texture = GetPedPropTextureIndex(playerPed, i)
            }
        end
        
        originalPlayerState.saved = true
        print('[DEBUG] Original player state saved')
    end
end

-- ==============================
-- CLEANUP TRASFORMAZIONE
-- ==============================
local function CleanupTransformation()
    -- Chiudi tutti i menu ox_lib attivi
    lib.hideContext()
    
    -- Interrompi tutte le animazioni attive
    local playerPed = PlayerPedId()
    ClearPedTasksImmediately(playerPed)
    
    -- Resetta effetti visivi
    SetNightvision(false)
    SetEntityAlpha(playerPed, 255, false)
    
    -- Rimuovi tutti i clipset applicati
    ResetPedMovementClipset(playerPed, 0.0)
    ResetPedStrafeClipset(playerPed)
    
    -- Ferma eventuali screen effects
    StopAllScreenEffects()
    
    -- Resetta modificatori di gioco
    SetRunSprintMultiplierForPlayer(PlayerId(), 1.0)
    SetPlayerMeleeWeaponDamageModifier(PlayerId(), 1.0)
    
    print('[DEBUG] Transformation cleanup completed')
end

-- ==============================
-- RIPRISTINA STATO ORIGINALE
-- ==============================
local function RestoreOriginalState()
    if originalPlayerState.saved then
        -- Prima fai cleanup di tutto
        CleanupTransformation()
        
        local playerId = PlayerId()
        
        -- Carica il modello originale
        RequestModel(originalPlayerState.hash)
        while not HasModelLoaded(originalPlayerState.hash) do
            Wait(10)
        end
        
        SetPlayerModel(playerId, originalPlayerState.hash)
        SetModelAsNoLongerNeeded(originalPlayerState.hash)
        
        Wait(500) -- Aspetta che il modello si carichi completamente
        
        local playerPed = PlayerPedId()
        
        -- Ripristina tutti i componenti
        for i = 0, 11 do
            local comp = originalPlayerState.components[i]
            if comp.drawable ~= -1 then
                SetPedComponentVariation(playerPed, i, comp.drawable, comp.texture, comp.palette)
            end
        end
        
        -- Ripristina tutti i props
        for i = 0, 7 do
            local prop = originalPlayerState.props[i]
            if prop.prop ~= -1 then
                SetPedPropIndex(playerPed, i, prop.prop, prop.texture, true)
            end
        end
        
        -- Resetta tutti gli stati delle creature
        creatureStates.isVampire = false
        creatureStates.isDemogorgon = false
        
        print('[DEBUG] Original player state restored')
        return true
    end
    return false
end

-- ==============================
-- GETTER/SETTER STATI
-- ==============================
local function SetCreatureState(creature, state)
    if creatureStates[creature] ~= nil then
        creatureStates[creature] = state
    end
end

local function GetCreatureState(creature)
    return creatureStates[creature] or false
end

local function IsAnyCreatureActive()
    for _, state in pairs(creatureStates) do
        if state then return true end
    end
    return false
end

-- ==============================
-- INIZIALIZAZIONE AUTOMATICA
-- ==============================
CreateThread(function()
    Wait(2000) -- Aspetta che il giocatore sia completamente caricato
    SaveOriginalState()
end)

-- ==============================
-- ESPORT FUNZIONI
-- ==============================
return {
    SaveOriginalState = SaveOriginalState,
    CleanupTransformation = CleanupTransformation,
    RestoreOriginalState = RestoreOriginalState,
    SetCreatureState = SetCreatureState,
    GetCreatureState = GetCreatureState,
    IsAnyCreatureActive = IsAnyCreatureActive
}
